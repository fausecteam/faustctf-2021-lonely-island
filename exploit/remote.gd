extends Node

const INFO := "[INFO]"
const WARN := "[WARN]"
const ERROR := "[ERROR]"

signal connected

var connection: Node

func fail(msg: String):
	logging(ERROR, msg)
	get_tree().quit(1)

func logging(level: String, msg: String):
	print("\t[", OS.get_process_id(), "]", level, " ", msg)

func connection_failed():
	logging(ERROR, "Could not connect to service")
	connection = null
	get_tree().quit(1)

func connection_aborted():
	logging(ERROR, "Lost connection to server")
	connection = null
	get_tree().quit(1)

func _ready():
	var peer := NetworkedMultiplayerENet.new()
	peer.connect("connection_failed", self, "connection_failed")
	peer.connect("server_disconnected", self, "connection_aborted")
	var port := OS.get_environment("PORT")
	if not port.is_valid_integer():
		logging(ERROR, "`" + port + "` is not a valid Port number")
		get_tree().quit(1)
		return
	var err := peer.create_client(OS.get_environment("HOST"), int(port))
	if err != OK:
		logging(ERROR, "Failed to create client: " + str(err))
		get_tree().quit(1)
		return
	get_tree().network_peer = peer
	
	yield(peer, "connection_succeeded")
	logging(INFO, "Connection established")
	connection = Node.new()
	connection.set_script(load("res://connection.gd"))
	connection.name = str(get_tree().get_network_unique_id())
	add_child(connection)
	emit_signal("connected")
	err = yield(register("h4x0r", "password", "H4k1NG U"), "completed")
	if not yield(login("h4x0r", "password"), "completed"):
		get_tree().quit(1)
		return
	if not join():
		get_tree().quit(1)
		return

func register(name: String, passwd: String, bio: String):
	if not connection:
		fail("Register: Connection is null")
		return "Register: Connection is null"
	logging(INFO, "Register(Name: '" + name + "', Password: '" + passwd + "', Bio: '" + bio + "')")
	connection.rpc_id(1, "register", name, passwd, bio)
	var error = yield(connection, "registered")
	if error:
		logging(WARN, "Register: Failed to create user: " + error)
	return error

func login(name: String, passwd: String):
	if not connection:
		fail("Login: Connection is null")
		return false
	logging(INFO, "Login(Name: '" + name + "', Password: '" + passwd + "')")
	connection.rpc_id(1, "login", name, passwd)
	var success = yield(connection, "login")
	if not success:
		logging(WARN, "Login: Failed to log in")
	return success

func get_friends() -> Dictionary:
	if not connection:
		fail("get_friends: Connection is null")
		return null
	logging(INFO, "get_friends()")
	connection.rpc_id(1, "get_friends")
	return yield(connection, "friendlist")

func add_friend(name: String):
	if not connection:
		fail("add_friend: Connection is null")
		return false
	logging(INFO, "add_friend(" + name + ")")
	connection.rpc_id(1, "add_friend", name)
	return true

func join():
	if not connection:
		fail("join: Connection is null")
		return false
	logging(INFO, "join()")
	connection.rpc_id(1, "join_game")
	$Game.visible = true
	return true

func print_flag(name: String):
	var friends = yield(get_friends(), "completed")
	if friends is Dictionary and name in friends and "bio" in friends[name]:
		print("Flag for user ", name, ": ", friends[name]["bio"])
